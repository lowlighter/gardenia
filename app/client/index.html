<!DOCTYPE html>
<html>
  <head>
    <title>Gardenia</title>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/site.webmanifest">
    <link rel="stylesheet" href="/css/matcha.css">
    <link rel="stylesheet" href="/app.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/js/alpine.min.js"></script>
    <script src="/js/chart.min.js"></script>
  </head>
  <body class="layout-simple" x-data="app">

    <!-- Header and main menu -->
    <header>
      <h1 x-text="settings.meta.instance_name ?? lang.app"></h1>
      <nav>
        <menu>
          <template x-if="status === 'configured' && (user.logged || settings.visibility.public_camera || settings.visibility.public_pictures || settings.visibility.public_data || settings.visibility.public_modules)">
            <li @click="tab = 'home'" :class="{selected:tab === 'home'}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M6.906.664a1.749 1.749 0 0 1 2.187 0l5.25 4.2c.415.332.657.835.657 1.367v7.019A1.75 1.75 0 0 1 13.25 15h-3.5a.75.75 0 0 1-.75-.75V9H7v5.25a.75.75 0 0 1-.75.75h-3.5A1.75 1.75 0 0 1 1 13.25V6.23c0-.531.242-1.034.657-1.366l5.25-4.2Zm1.25 1.171a.25.25 0 0 0-.312 0l-5.25 4.2a.25.25 0 0 0-.094.196v7.019c0 .138.112.25.25.25H5.5V8.25a.75.75 0 0 1 .75-.75h3.5a.75.75 0 0 1 .75.75v5.25h2.75a.25.25 0 0 0 .25-.25V6.23a.25.25 0 0 0-.094-.195Z"></path></svg>
            </li>
          </template>
          <template x-if="status === 'configured' && user.grant_automation">
            <li @click="tab = 'automation'" :class="{selected:tab === 'automation'}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M0 2.75C0 1.784.784 1 1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0 1 14.25 15H1.75A1.75 1.75 0 0 1 0 13.25Zm1.75-.25a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25V2.75a.25.25 0 0 0-.25-.25ZM7.25 8a.749.749 0 0 1-.22.53l-2.25 2.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734L5.44 8 3.72 6.28a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l2.25 2.25c.141.14.22.331.22.53Zm1.5 1.5h3a.75.75 0 0 1 0 1.5h-3a.75.75 0 0 1 0-1.5Z"></path></svg>
            </li>
          </template>
          <template x-if="status === 'configured' && user.logged">
            <li @click="tab = 'user'" :class="{selected:tab === 'user'}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M10.561 8.073a6.005 6.005 0 0 1 3.432 5.142.75.75 0 1 1-1.498.07 4.5 4.5 0 0 0-8.99 0 .75.75 0 0 1-1.498-.07 6.004 6.004 0 0 1 3.431-5.142 3.999 3.999 0 1 1 5.123 0ZM10.5 5a2.5 2.5 0 1 0-5 0 2.5 2.5 0 0 0 5 0Z"></path></svg>
            </li>
          </template>
          <template x-if="status === 'configured' && user.grant_admin">
            <li @click="tab = 'settings'" :class="{selected:tab === 'settings'}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 0a8.2 8.2 0 0 1 .701.031C9.444.095 9.99.645 10.16 1.29l.288 1.107c.018.066.079.158.212.224.231.114.454.243.668.386.123.082.233.09.299.071l1.103-.303c.644-.176 1.392.021 1.82.63.27.385.506.792.704 1.218.315.675.111 1.422-.364 1.891l-.814.806c-.049.048-.098.147-.088.294.016.257.016.515 0 .772-.01.147.038.246.088.294l.814.806c.475.469.679 1.216.364 1.891a7.977 7.977 0 0 1-.704 1.217c-.428.61-1.176.807-1.82.63l-1.102-.302c-.067-.019-.177-.011-.3.071a5.909 5.909 0 0 1-.668.386c-.133.066-.194.158-.211.224l-.29 1.106c-.168.646-.715 1.196-1.458 1.26a8.006 8.006 0 0 1-1.402 0c-.743-.064-1.289-.614-1.458-1.26l-.289-1.106c-.018-.066-.079-.158-.212-.224a5.738 5.738 0 0 1-.668-.386c-.123-.082-.233-.09-.299-.071l-1.103.303c-.644.176-1.392-.021-1.82-.63a8.12 8.12 0 0 1-.704-1.218c-.315-.675-.111-1.422.363-1.891l.815-.806c.05-.048.098-.147.088-.294a6.214 6.214 0 0 1 0-.772c.01-.147-.038-.246-.088-.294l-.815-.806C.635 6.045.431 5.298.746 4.623a7.92 7.92 0 0 1 .704-1.217c.428-.61 1.176-.807 1.82-.63l1.102.302c.067.019.177.011.3-.071.214-.143.437-.272.668-.386.133-.066.194-.158.211-.224l.29-1.106C6.009.645 6.556.095 7.299.03 7.53.01 7.764 0 8 0Zm-.571 1.525c-.036.003-.108.036-.137.146l-.289 1.105c-.147.561-.549.967-.998 1.189-.173.086-.34.183-.5.29-.417.278-.97.423-1.529.27l-1.103-.303c-.109-.03-.175.016-.195.045-.22.312-.412.644-.573.99-.014.031-.021.11.059.19l.815.806c.411.406.562.957.53 1.456a4.709 4.709 0 0 0 0 .582c.032.499-.119 1.05-.53 1.456l-.815.806c-.081.08-.073.159-.059.19.162.346.353.677.573.989.02.03.085.076.195.046l1.102-.303c.56-.153 1.113-.008 1.53.27.161.107.328.204.501.29.447.222.85.629.997 1.189l.289 1.105c.029.109.101.143.137.146a6.6 6.6 0 0 0 1.142 0c.036-.003.108-.036.137-.146l.289-1.105c.147-.561.549-.967.998-1.189.173-.086.34-.183.5-.29.417-.278.97-.423 1.529-.27l1.103.303c.109.029.175-.016.195-.045.22-.313.411-.644.573-.99.014-.031.021-.11-.059-.19l-.815-.806c-.411-.406-.562-.957-.53-1.456a4.709 4.709 0 0 0 0-.582c-.032-.499.119-1.05.53-1.456l.815-.806c.081-.08.073-.159.059-.19a6.464 6.464 0 0 0-.573-.989c-.02-.03-.085-.076-.195-.046l-1.102.303c-.56.153-1.113.008-1.53-.27a4.44 4.44 0 0 0-.501-.29c-.447-.222-.85-.629-.997-1.189l-.289-1.105c-.029-.11-.101-.143-.137-.146a6.6 6.6 0 0 0-1.142 0ZM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0ZM9.5 8a1.5 1.5 0 1 0-3.001.001A1.5 1.5 0 0 0 9.5 8Z"></path></svg>
            </li>
          </template>
          <template x-if="status === 'configured' && user.logged">
            <li @click="await api($event, '/logout', {callback:() => location.reload(), method:'POST'})">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M2 2.75C2 1.784 2.784 1 3.75 1h2.5a.75.75 0 0 1 0 1.5h-2.5a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h2.5a.75.75 0 0 1 0 1.5h-2.5A1.75 1.75 0 0 1 2 13.25Zm10.44 4.5-1.97-1.97a.749.749 0 0 1 .326-1.275.749.749 0 0 1 .734.215l3.25 3.25a.75.75 0 0 1 0 1.06l-3.25 3.25a.749.749 0 0 1-1.275-.326.749.749 0 0 1 .215-.734l1.97-1.97H6.75a.75.75 0 0 1 0-1.5Z"></path></svg>
            </li>
          </template>
          <template x-if="status === 'configured' && user.logged === null">
            <li @click="tab = 'login'" :class="{selected:tab === 'login'}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M2 2.75C2 1.784 2.784 1 3.75 1h2.5a.75.75 0 0 1 0 1.5h-2.5a.25.25 0 0 0-.25.25v10.5c0 .138.112.25.25.25h2.5a.75.75 0 0 1 0 1.5h-2.5A1.75 1.75 0 0 1 2 13.25Zm6.56 4.5h5.69a.75.75 0 0 1 0 1.5H8.56l1.97 1.97a.749.749 0 0 1-.326 1.275.749.749 0 0 1-.734-.215L6.22 8.53a.75.75 0 0 1 0-1.06l3.25-3.25a.749.749 0 0 1 1.275.326.749.749 0 0 1-.215.734Z"></path></svg>
            </li>
          </template>
          <template x-if="status === 'unconfigured'">
            <li :class="{selected:tab === 'setup'}">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M14.064 0h.186C15.216 0 16 .784 16 1.75v.186a8.752 8.752 0 0 1-2.564 6.186l-.458.459c-.314.314-.641.616-.979.904v3.207c0 .608-.315 1.172-.833 1.49l-2.774 1.707a.749.749 0 0 1-1.11-.418l-.954-3.102a1.214 1.214 0 0 1-.145-.125L3.754 9.816a1.218 1.218 0 0 1-.124-.145L.528 8.717a.749.749 0 0 1-.418-1.11l1.71-2.774A1.748 1.748 0 0 1 3.31 4h3.204c.288-.338.59-.665.904-.979l.459-.458A8.749 8.749 0 0 1 14.064 0ZM8.938 3.623h-.002l-.458.458c-.76.76-1.437 1.598-2.02 2.5l-1.5 2.317 2.143 2.143 2.317-1.5c.902-.583 1.74-1.26 2.499-2.02l.459-.458a7.25 7.25 0 0 0 2.123-5.127V1.75a.25.25 0 0 0-.25-.25h-.186a7.249 7.249 0 0 0-5.125 2.123ZM3.56 14.56c-.732.732-2.334 1.045-3.005 1.148a.234.234 0 0 1-.201-.064.234.234 0 0 1-.064-.201c.103-.671.416-2.273 1.15-3.003a1.502 1.502 0 1 1 2.12 2.12Zm6.94-3.935c-.088.06-.177.118-.266.175l-2.35 1.521.548 1.783 1.949-1.2a.25.25 0 0 0 .119-.213ZM3.678 8.116 5.2 5.766c.058-.09.117-.178.176-.266H3.309a.25.25 0 0 0-.213.119l-1.2 1.95ZM12 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>
            </li>
          </template>
        </menu>
      </nav>
    </header>

    <!-- Content -->
    <main>
      <!-- Flash messages -->
      <div class="fixed" style="top: calc(var(--ly-header-size) + .5rem); left: 0; right: 0; z-index: 100;">
        <section data-flash></section>
      </div>

      <!-- Status -->
      <div class="fixed" style="bottom: .5rem; right: .5rem; z-index: 100;">
        <div class="flex end">
          <div class="flex p-.5 bg-muted bd-muted rounded">
            <svg :class="{success:ping.internet, danger:!ping.internet}" class="mr-.5" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 0a8 8 0 1 1 0 16A8 8 0 0 1 8 0ZM5.78 8.75a9.64 9.64 0 0 0 1.363 4.177c.255.426.542.832.857 1.215.245-.296.551-.705.857-1.215A9.64 9.64 0 0 0 10.22 8.75Zm4.44-1.5a9.64 9.64 0 0 0-1.363-4.177c-.307-.51-.612-.919-.857-1.215a9.927 9.927 0 0 0-.857 1.215A9.64 9.64 0 0 0 5.78 7.25Zm-5.944 1.5H1.543a6.507 6.507 0 0 0 4.666 5.5c-.123-.181-.24-.365-.352-.552-.715-1.192-1.437-2.874-1.581-4.948Zm-2.733-1.5h2.733c.144-2.074.866-3.756 1.58-4.948.12-.197.237-.381.353-.552a6.507 6.507 0 0 0-4.666 5.5Zm10.181 1.5c-.144 2.074-.866 3.756-1.58 4.948-.12.197-.237.381-.353.552a6.507 6.507 0 0 0 4.666-5.5Zm2.733-1.5a6.507 6.507 0 0 0-4.666-5.5c.123.181.24.365.353.552.714 1.192 1.436 2.874 1.58 4.948Z"></path></svg>
            <svg :class="{success:ping.camera, danger:!ping.camera}" class="mr-.5" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M16 3.75v8.5a.75.75 0 0 1-1.136.643L11 10.575v.675A1.75 1.75 0 0 1 9.25 13h-7.5A1.75 1.75 0 0 1 0 11.25v-6.5C0 3.784.784 3 1.75 3h7.5c.966 0 1.75.784 1.75 1.75v.675l3.864-2.318A.75.75 0 0 1 16 3.75Zm-6.5 1a.25.25 0 0 0-.25-.25h-7.5a.25.25 0 0 0-.25.25v6.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-6.5ZM11 8.825l3.5 2.1v-5.85l-3.5 2.1Z"></path></svg>
            <svg :class="{success:ping.control, danger:!ping.control}" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="m10.41.24 4.711 2.774c.544.316.878.897.879 1.526v5.01a1.77 1.77 0 0 1-.88 1.53l-7.753 4.521-.002.001a1.769 1.769 0 0 1-1.774 0H5.59L.873 12.85A1.761 1.761 0 0 1 0 11.327V6.292c0-.304.078-.598.22-.855l.004-.005.01-.019c.15-.262.369-.486.64-.643L8.641.239a1.752 1.752 0 0 1 1.765 0l.002.001ZM9.397 1.534l-7.17 4.182 4.116 2.388a.27.27 0 0 0 .269 0l7.152-4.148-4.115-2.422a.252.252 0 0 0-.252 0Zm-7.768 10.02 4.1 2.393V9.474a1.807 1.807 0 0 1-.138-.072L1.5 7.029v4.298c0 .095.05.181.129.227Zm8.6.642 1.521-.887v-4.45l-1.521.882ZM7.365 9.402h.001c-.044.026-.09.049-.136.071v4.472l1.5-.875V8.61Zm5.885 1.032 1.115-.65h.002a.267.267 0 0 0 .133-.232V5.264l-1.25.725Z"></path></svg>
          </div>
        </div>
        <var class="bd-muted"><span class="muted" x-text="lang.utc_time"></span> <span x-text="new Date(t).toISOString().slice(0, 16)"></span></var>
      </div>

      <!-- Home -->
      <template x-if="tab === 'home'">
        <div>
          <!-- Camera -->
          <template x-if="user.logged || settings.visibility.public_camera || settings.visibility.public_pictures">
            <div class="camera" x-data="{source:'/camera'}">
              <div class="camera-wrapper">
                <img :src="source" alt="">
              </div>
              <div class="centered">
                <template x-if="user.logged || settings.visibility.public_pictures">
                  <select x-model.fill="source">
                    <template x-if="user.logged || settings.visibility.public_camera">
                      <option value="/camera" x-text="lang.data_camera"></option>
                    </template>
                    <template x-if="user.logged || settings.visibility.public_pictures">
                      <template x-for="picture in [...(!(user.logged || settings.visibility.public_camera) ? [''] : []), ...pictures]" :key="picture">
                        <option :value="`/api/pictures/${picture}`" :disabled="!picture" x-text="picture || lang.select_placeholder"></option>
                      </template>
                    </template>
                  </select>
                </template>
                <template x-if="(source !== '/camera')&&(user.grant_admin || user.grant_data)">
                  <button class="danger mt-1" @click="await api($event, source, {callback:() => refresh_pictures(), method:'DELETE'})" type="submit" x-text="lang.picture_delete"></button>
                </template>
              </div>
            </div>
          </template>
          <!-- Modules -->
          <template x-if="user.logged || settings.visibility.public_modules">
            <div>
              <h2 x-text="lang.automation_modules"></h2>
              <div class="modules grid">
                <template x-for="target in overview.targets" :key="target.module">
                  <article class="module" :class="{disabled:target.disabled}">
                    <header>
                      <small class="muted">
                        <span x-text="target.module === 'picamera' ? lang.automation_target_module_picamera : target.module_hint"></span>
                      </small>
                      <h3 x-text="target.name"></h3>
                    </header>
                    <div>
                      <template x-if="target.status === 'on'">
                        <div class="rounded px-.5 bg-success success" x-text="lang.on"></div>
                      </template>
                      <template x-if="target.status === 'off'">
                        <div class="rounded px-.5 bg-danger danger" x-text="lang.off"></div>
                      </template>
                      <template x-if="target.status === 'unknown'">
                        <div class="rounded px-.5 bg-muted muted" x-text="lang.unknown"></div>
                      </template>
                      <template x-if="target.status_details">
                        <p>
                          <small class="muted">
                            <template x-if="(target.status === 'on')&&(target.status_details.duration)">
                              <progress class="success" :max="target.status_details.t2 - target.status_details.t1" :value="t - target.status_details.t1"></progress>
                            </template>
                            <span x-text="lang.automation_updated_by_rule"></span>
                            <var x-text="target.status_details.rule"></var>
                            <span x-text="lang.automation_updated_by_rule_at"></span>
                            <var x-text="target.status_details.at"></var>
                            <template x-if="target.status_details.duration">
                              <div>
                                <span x-text="lang.automation_updated_by_rule_for"></span>
                                <var x-text="target.status_details.duration"></var>
                                <span x-text="lang.automation_updated_by_rule_seconds"></span>
                              </div>
                            </template>
                          </small>
                        </p>
                      </template>
                      <!-- Manual handling -->
                      <template x-if="user.grant_automation">
                        <div>
                          <template x-if="(!target.disabled)&&(target.status !== 'unknown')&&(target.module !== 'picamera')">
                            <form class="mt-.5" x-data="{data:{duration:0}}">
                              <template x-if="target.status === 'off'">
                                <label>
                                  <span x-html="lang.automation_rule_duration"></span><br>
                                  <small x-html="lang.automation_rule_duration_desc"></small>
                                  <input x-model="data.duration" type="number" required>
                                </label>
                              </template>
                              <footer>
                                <template x-if="target.status === 'off'">
                                  <button class="success" @click="await api($event, `/api/action/${encodeURIComponent(target.module)}`, {callback:() => refresh_overview(), method:'POST', body:JSON.stringify({action:'on', ...data})})" type="submit" x-text="lang.manual_action_on"></button>
                                </template>
                                <template x-if="target.status === 'on'">
                                  <button class="danger" @click="await api($event, `/api/action/${encodeURIComponent(target.module)}`, {callback:() => refresh_overview(), method:'POST', body:JSON.stringify({action:'off', ...data})})" type="submit" x-text="lang.manual_action_off"></button>
                                </template>
                              </footer>
                            </form>
                          </template>
                          <template x-if="(!target.disabled)&&(target.status === 'unknown')">
                            <form class="mt-.5">
                              <small class="muted" x-text="lang.manual_action_unavailable"></small>
                            </form>
                          </template>
                          <template x-if="target.disabled">
                            <form class="mt-.5">
                              <small class="muted" x-text="lang.manual_action_unavailable_because_target_disabled"></small>
                            </form>
                          </template>
                          <template x-if="(!target.disabled)&&(target.module === 'picamera')">
                            <form class="mt-.5">
                              <footer>
                                <button class="active" @click="await api($event, '/api/pictures', {callback:() => refresh_pictures(), method:'POST'})" type="submit" x-text="lang.manual_action_picture"></button>
                              </footer>
                            </form>
                          </template>
                        </div>
                      </template>
                    </div>
                  </article>
                </template>
              </div>
              <template x-if="!overview.targets.length">
                <section>
                  <div class="flash muted" x-html="lang.automation_target_empty"></div>
                </section>
              </template>
            </div>
          </template>
          <!-- Data -->
          <template x-if="user.grant_data || settings.visibility.public_data">
            <div>
              <h2 x-text="lang.data"></h2>
              <!-- Data range -->
              <div class="mt-1 flex filter" x-data="{section:'graphs', endpoint:'/api/data', data:graphs.range}">
                <template x-for="({name, disabled, required, placeholder, type}) in [{name:'from', required:true, type:'datetime-local'}, {name:'to', required:true, type:'datetime-local'}]" :key="name">
                  <label class="mr-1">
                    <span x-html="lang[`${section}_${name}`]"></span>
                    <input @change="await refresh_graphs(null)" x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
                  </label>
                </template>
              </div>
              <!-- Graphs -->
              <div class="graphs grid">
                <template x-for="({current, min, max, trend, unit, graph_type, graph}, key) in graphs.data" :key="key">
                  <template x-if="graph">
                    <article class="graph">
                      <header>
                        <small class="muted" x-html="lang[`data_${key}`]"></small>
                        <div class="trend inline block">
                          <template x-if="trend === 'down'">
                            <svg class="danger" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9m0 8l-8-8-4 4-6-6"/></svg>
                          </template>
                          <template x-if="trend === 'up'">
                            <svg class="success" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                          </template>
                        </div>
                        <h3>
                          <span x-text="`${current ?? '-'} ${unit}`"></span>
                          <template x-if="graphs.data[`${key}_out`]">
                            <small class="muted">
                              (<span x-text="`${graphs.data[`${key}_out`].current ?? '-'} ${unit}`"></span> <span x-text="lang.data_is_outdoor"></span>)
                            </small>
                          </template>
                        </h3>
                        <small>
                          <span x-text="min ?? '-'"></span> <span x-text="lang.data_range_separator"></span> <span x-text="`${max ?? '-'} ${unit}`"></span>
                        </small>
                        <template x-if="graphs.data[`${key}_out`]">
                          <small class="muted">
                            (<span x-text="graphs.data[`${key}_out`].min ?? '-'"></span> <span x-text="lang.data_range_separator"></span> <span x-text="`${graphs.data[`${key}_out`].max ?? '-'} ${unit}`"></span> <span x-text="lang.data_is_outdoor"></span>)
                          </small>
                        </template>
                      </header>
                      <div :style="{maxHeight: `${graph_type === 'polarArea' ? 200 : 300}px`}">
                        <canvas :style="{margin: graph_type === 'polarArea' ? 'auto' : ''}" :data-graph="key"></canvas>
                      </div>
                    </article>
                  </template>
                </template>
              </div>
              <template x-if="!Object.values(graphs.data).reduce((a, b) => a || b.graph, false)">
                <section>
                  <div class="flash muted" x-html="lang.data_empty"></div>
                </section>
              </template>
            </div>
          </template>
          <!-- History -->
          <template x-if="user.logged || settings.visibility.public_history">
            <div>
              <!-- History filter -->
              <h2 x-html="lang.history"></h2>
              <div class="mt-1 flex filter">
                <label class="mr-1">
                  <span x-html="lang.history_page"></span>
                  <input required type="number" min="1" x-model="history.page" @change="refresh_history()">
                </label>
                <label class="mr-1">
                  <span x-html="lang.history_limit"></span>
                  <input required type="number" min="1" x-model="history.limit" @change="refresh_history()">
                </label>
                <template x-if="user.grant_admin">
                  <label class="mr-1">
                    <span x-html="lang.history_logs"></span>
                    <select x-model="history.logs" @change="refresh_history()">
                      <option value="no" x-text="lang.no"></option>
                      <option value="yes" x-text="lang.yes"></option>
                    </select>
                  </label>
                </template>
              </div>
              <!-- History entries -->
              <section>
                <template x-if="!history.entries.length">
                  <div class="flash muted" x-html="lang.history_empty"></div>
                </template>
                <template x-if="history.entries.length">
                  <div class="table-responsive">
                    <table>
                      <tbody>
                        <template x-for="entry in history.entries" :key="`${entry.t}-${entry.action}-${entry.user}`">
                          <tr>
                            <td><small class="muted" x-text="entry.at"></small></td>
                            <td x-html="history_format(entry)"></td>
                          </tr>
                        </template>
                      </tbody>
                    </table>
                  </div>
                </template>
              </section>
            </div>
          </template>
        </div>
      </template>

      <!-- Login -->
      <template x-if="tab === 'login'">
        <section>
          <form x-data="{section:'login', endpoint:'/login', data:user, show_password:false}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, required, placeholder, type}) in [{name:'username', required:true}, {name:'password', required:true, type:show_password ? 'text' : 'password'}]" :key="name">
              <label class="relative">
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <template x-if="name === 'password'">
                  <div class="absolute" style="z-index: 50; bottom: 0.25rem; right: .5rem;">
                    <template x-if="!show_password">
                      <svg @click="show_password = true" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 2c1.981 0 3.671.992 4.933 2.078 1.27 1.091 2.187 2.345 2.637 3.023a1.62 1.62 0 0 1 0 1.798c-.45.678-1.367 1.932-2.637 3.023C11.67 13.008 9.981 14 8 14c-1.981 0-3.671-.992-4.933-2.078C1.797 10.83.88 9.576.43 8.898a1.62 1.62 0 0 1 0-1.798c.45-.677 1.367-1.931 2.637-3.022C4.33 2.992 6.019 2 8 2ZM1.679 7.932a.12.12 0 0 0 0 .136c.411.622 1.241 1.75 2.366 2.717C5.176 11.758 6.527 12.5 8 12.5c1.473 0 2.825-.742 3.955-1.715 1.124-.967 1.954-2.096 2.366-2.717a.12.12 0 0 0 0-.136c-.412-.621-1.242-1.75-2.366-2.717C10.824 4.242 9.473 3.5 8 3.5c-1.473 0-2.825.742-3.955 1.715-1.124.967-1.954 2.096-2.366 2.717ZM8 10a2 2 0 1 1-.001-3.999A2 2 0 0 1 8 10Z"></path></svg>
                    </template>
                    <template x-if="show_password">
                      <svg @click="show_password = false" fill="currentColor" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M.143 2.31a.75.75 0 0 1 1.047-.167l14.5 10.5a.75.75 0 1 1-.88 1.214l-2.248-1.628C11.346 13.19 9.792 14 8 14c-1.981 0-3.67-.992-4.933-2.078C1.797 10.832.88 9.577.43 8.9a1.619 1.619 0 0 1 0-1.797c.353-.533.995-1.42 1.868-2.305L.31 3.357A.75.75 0 0 1 .143 2.31Zm1.536 5.622A.12.12 0 0 0 1.657 8c0 .021.006.045.022.068.412.621 1.242 1.75 2.366 2.717C5.175 11.758 6.527 12.5 8 12.5c1.195 0 2.31-.488 3.29-1.191L9.063 9.695A2 2 0 0 1 6.058 7.52L3.529 5.688a14.207 14.207 0 0 0-1.85 2.244ZM8 3.5c-.516 0-1.017.09-1.499.251a.75.75 0 1 1-.473-1.423A6.207 6.207 0 0 1 8 2c1.981 0 3.67.992 4.933 2.078 1.27 1.091 2.187 2.345 2.637 3.023a1.62 1.62 0 0 1 0 1.798c-.11.166-.248.365-.41.587a.75.75 0 1 1-1.21-.887c.148-.201.272-.382.371-.53a.119.119 0 0 0 0-.137c-.412-.621-1.242-1.75-2.366-2.717C10.825 4.242 9.473 3.5 8 3.5Z"></path></svg>
                    </template>
                  </div>
                </template>
                <input x-model="data[name]" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <footer>
              <button type="submit" @click="await api($event, endpoint, {callback:() => location.reload(), method:'POST', body:JSON.stringify(data)})" x-text="lang.login_button"></button>
            </footer>
          </form>
        </section>
      </template>

      <!-- User -->
      <template x-if="tab === 'user'">
        <section x-data="{data:user, method:'PUT', endpoint:`/api/users/${encodeURIComponent(user.username)}`, grant_admin:user.grant_admin, form_visible:true}">
          <!-- User list -->
          <template x-if="user.grant_admin">
            <div class="table-responsive">
              <table class="mt-1">
                <thead>
                  <tr>
                    <th x-text="lang.user_username"></th>
                    <th x-text="lang.user_logged"></th>
                    <th x-text="lang.user_grant_admin"></th>
                    <th x-text="lang.user_grant_automation"></th>
                    <th x-text="lang.user_grant_data"></th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="user in users" :key="user.username">
                    <tr :class="{selected:user.username === data.username}" @click="user.username === data.username ? (form_visible = false, data = {}) : (form_visible = true, method = 'PUT', endpoint = `/api/users/${encodeURIComponent(user.username)}`, data = user)">
                      <td x-text="user.username"></td>
                      <td x-text="user.logged ? user.logged : lang.user_logged_never"></td>
                      <td x-text="user.grant_admin ? lang.yes : lang.no"></td>
                      <td x-text="user.grant_admin ? '' : user.grant_automation ? lang.yes : lang.no"></td>
                      <td x-text="user.grant_admin ? '' : user.grant_data ? lang.yes : lang.no"></td>
                    </tr>
                  </template>
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="5">
                      <button class="success" x-text="lang.user_button_create" @click="form_visible = true; method = 'POST'; endpoint = '/api/users'; data = {username:'', logged:null, password:'', grant_admin:false, grant_automation:false, grant_data:false}"></button>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </template>
          <!-- User form -->
          <template x-if="form_visible">
            <form x-data="{section:'user'}">
              <h2 x-html="lang[section]"></h2>
              <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
              <template x-for="({name, disabled, required, placeholder, type}) in [{name:'username', disabled:method !== 'POST'}, {name:'logged', disabled:true, type:'datetime-local'}, {name:'password', required:true, type:'password'}, {name:'grant_admin', type:'checkbox', disabled:!grant_admin}, {name:'grant_automation', type:'checkbox', disabled:!grant_admin}, {name:'grant_data', type:'checkbox', disabled:!grant_admin}]" :key="name">
                <template x-if="!(((name === 'logged')&&(method === 'POST'))||((name === 'grant_automation')&&(data.grant_admin))||((name === 'grant_data')&&(data.grant_admin)))">
                  <label>
                    <span x-html="lang[`${section}_${name}`]"></span><br>
                    <small x-html="lang[`${section}_${name}_desc`]"></small>
                    <template x-if="type === 'checkbox'">
                      <br>
                    </template>
                    <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
                  </label>
                </template>
              </template>
              <footer>
                <template x-if="method !== 'POST'">
                  <button type="reset" @click="await api($event, endpoint, {callback:() => { refresh_users(); form_visible = false }, method:'DELETE'})" x-text="lang.user_button_delete"></button>
                </template>
                <button type="submit" @click="await api($event, endpoint, {callback:() => { refresh_users(); if (method === 'POST') { form_visible = false ; data = {} } }, method, body:JSON.stringify(data)})" x-text="method === 'POST' ? lang.user_button_create : lang.user_button"></button>
              </footer>
            </form>
          </template>
        </section>
      </template>

      <!-- Automation -->
      <template x-if="tab === 'automation'">
        <section>
          <!-- Automation targets -->
          <div x-data="{data:{icon:'', name:'', module:'', disabled:false}, method:'', endpoint:'/api/automation/targets', form_visible:false}">
            <h2 x-html="lang.automation_target"></h2>
            <div class="muted mb-1" x-html="lang.automation_target_desc"></div>
            <!-- Automation target list -->
            <div class="table-responsive">
              <table class="mt-1">
                <thead>
                  <tr>
                    <th></th>
                    <th x-text="lang.automation_target_name"></th>
                    <th x-text="lang.automation_target_module"></th>
                    <th x-text="lang.automation_target_disabled"></th>
                  </tr>
                </thead>
                <tbody>
                  <template x-for="target in automation.targets" :key="target.module">
                    <tr :class="{selected:target.module === data.module}" @click="target.module === data.module ? (form_visible = false, data = {}) : (form_visible = true, method = 'PUT', endpoint = `/api/automation/targets/${encodeURIComponent(target.module)}`, data = target)">
                      <td><img class="automation-icon" :src="`/svg/${target.icon || 'box'}.svg`" alt=""></td>
                      <td x-text="target.name"></td>
                      <td x-text="target.module"></td>
                      <td x-text="target.disabled ? lang.yes : lang.no"></td>
                    </tr>
                  </template>
                  <template x-if="!automation.targets.length">
                    <tr>
                      <td colspan="4" class="muted" x-text="lang.automation_target_empty"></td>
                    </tr>
                  </template>
                </tbody>
                <template x-if="user.grant_automation">
                  <tfoot>
                    <tr>
                      <td colspan="4">
                        <button class="success" x-text="lang.automation_target_button_create" @click="form_visible = true; method = 'POST'; endpoint = '/api/automation/targets'; data = {icon:'', name:'', module:'', disabled:false}"></button>
                      </td>
                    </tr>
                  </tfoot>
                </template>
              </table>
            </div>
            <template x-if="form_visible">
              <!-- Automation target form -->
              <form>
                <div>
                  <span x-html="lang.automation_target_icon"></span><br>
                  <small class="muted" x-html="lang.automation_target_icon_desc"></small>
                  <div class="flex">
                    <template x-for="icon in icons" :key="icon">
                      <label class="mr-1">
                        <img class="automation-icon" :class="{selected:data.icon === icon}" :src="`/svg/${icon || 'box'}.svg`" alt="">
                        <input x-model="data.icon" type="radio" :value="icon">
                      </label>
                    </template>
                  </div>
                </div>
                <label>
                  <span x-html="lang.automation_target_name"></span><br>
                  <small x-html="lang.automation_target_name_desc"></small>
                  <input x-model="data.name" type="text" required>
                </label>
                <label>
                  <span x-html="lang.automation_target_module"></span><br>
                  <small x-html="lang.automation_target_module_desc"></small>
                  <select x-model="data.module" required>
                    <option value="" disabled x-text="lang.select_placeholder"></option>
                    <template x-for="module in settings.tapo_modules" :key="module.mac">
                      <option :value="module.mac" x-text="`${module.name} (${module.mac})`" :selected="data.module === module.mac"></option>
                    </template>
                    <option value="picamera" x-text="lang.automation_target_module_picamera" :selected="data.module === 'picamera'"></option>
                  </select>
                </label>
                <label>
                  <span x-html="lang.automation_target_disabled"></span><br>
                  <small x-html="lang.automation_target_disabled_desc"></small><br>
                  <input x-model="data.disabled" type="checkbox">
                </label>
                <footer>
                  <template x-if="method !== 'POST'">
                    <button type="reset" @click="await api($event, endpoint, {callback:() => { refresh_automation(); form_visible = false }, method:'DELETE'})" x-text="lang.automation_target_button_delete"></button>
                  </template>
                  <button type="submit" @click="await api($event, endpoint, {callback:() => { refresh_automation(); if (method === 'POST') { form_visible = false ; data = {} } }, method, body:JSON.stringify(data)})" x-text="method === 'POST' ? lang.automation_target_button_create : lang.automation_target_button"></button>
                </footer>
              </form>
            </template>
          </div>
          <!-- Automation rules -->
          <div x-data="{data:{name:'', priority:0, action:'on', duration:0, hits:0, last_hit:null, target:'', conditions:[]}, method:'', endpoint:'/api/automation/rules', form_visible:false}">
            <h2 x-html="lang.automation_rule"></h2>
            <div class="muted mb-1" x-html="lang.automation_rule_desc"></div>
            <!-- Automation rule list -->
            <template x-if="!automation.targets.length">
              <div class="flash muted" x-html="lang.automation_target_empty"></div>
            </template>
            <template x-if="automation.targets.length">
              <div>
                <template x-for="rule in automation.rules" :key="rule.name">
                  <article class="mb-1" :class="{'bd-active':rule.name === data.name}" @click="rule.name === data.name ? (form_visible = false, data = {}) : (form_visible = true, method = 'PUT', endpoint = `/api/automation/rules/${encodeURIComponent(rule.name)}`, data = rule)">
                    <header>
                      <h3>
                        <img class="automation-icon" :src="`/svg/${Object.values(automation.targets).find(target => target.module === rule.target)?.icon || 'box'}.svg`" alt="">
                        <span x-text="rule.name"></span>
                      </h3>
                      <small class="muted">
                        <var x-text="Object.values(automation.targets).find(target => target.module === rule.target)?.name"></var>
                      </small><br>
                      <code class="muted" x-text="`${lang.automation_rule_priority} ${rule.priority}`"></code>
                      <code class="muted" x-text="`${lang.automation_rule_hits_count} ${rule.hits}`"></code>
                      <template x-if="rule.last_hit">
                        <code class="muted" x-text="`${lang.automation_rule_last_hit} ${rule.last_hit}`"></code>
                      </template>
                      <template x-if="rule.ratelimit">
                        <code class="muted" x-text="`${lang.automation_rule_ratelimit_text} ${rule.ratelimit}s`"></code>
                      </template>
                      <template x-if="rule.disabled">
                        <code class="muted" x-text="lang.automation_rule_disabled"></code>
                      </template>
                    </header>
                    <p>
                      <code x-text="rule.target === 'picamera' ? lang.automation_rule_action_picture : `${lang[`automation_rule_action_${rule.action}`]}`"></code>
                      <template x-if="(rule.target !== 'picamera')&&(rule.action === 'on')">
                        <code x-text="`${rule.duration}s`"></code>
                      </template>
                      <small x-text="lang.automation_rule_conditions_text"></small> :
                    </p>
                    <ul>
                      <template x-for="{data, operator, value, delta} in rule.conditions">
                        <li>
                          <var x-text="lang[`data_${data}`]"></var>
                          <span x-text="lang[`automation_rule_operator_${operator}`]"></span>
                          <code x-text="value"></code>
                          <template x-if="(delta)&&(operator === '==')">
                            <span x-text="lang.automation_rule_delta"></span>
                          </template>
                          <template x-if="(delta)&&(operator === '==')">
                            <code x-text="delta"></code>
                          </template>
                        </li>
                      </template>
                    </ul>
                  </article>
                </template>
                <template x-if="user.grant_automation">
                  <button class="success my-1" x-text="lang.automation_rule_button_create" @click="form_visible = true; method = 'POST'; endpoint = '/api/automation/rules'; data = {name:'', hits:0, last_hit:null, target:'', priority:0, action:'on', duration:0, conditions:[], ratelimit:0, disabled:false}"></button>
                </template>
                <template x-if="!automation.rules.length">
                  <div class="flash muted" x-html="lang.automation_rule_empty"></div>
                </template>
              </div>
            </template>
            <template x-if="form_visible">
              <!-- Automation rule form -->
              <form x-data="{section:'automation_rule'}">
                <template x-for="({name, disabled, required, placeholder, type}) in [{name:'name', required:true}, {name:'hits', type:'number', disabled:true}, {name:'last_hit', type:'datetime-local', disabled:true}, {name:'priority', type:'number'}, {name:'disabled', type:'checkbox'}]" :key="name">
                  <template x-if="!((method === 'POST')&&((name === 'hits')||(name === 'last_hit')))">
                    <label>
                      <span x-html="lang[`${section}_${name}`]"></span><br>
                      <small x-html="lang[`${section}_${name}_desc`]"></small>
                      <template x-if="type === 'checkbox'">
                        <br>
                      </template>
                      <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
                    </label>
                  </template>
                </template>
                <label>
                  <span x-html="lang.automation_rule_target"></span><br>
                  <small x-html="lang.automation_rule_target_desc"></small>
                  <select x-model="data.target" required>
                    <option value="" disabled x-text="lang.select_placeholder"></option>
                    <template x-for="target in automation.targets" :key="target.module">
                      <option :value="target.module" x-text="target.name" :selected="data.target === target.module"></option>
                    </template>
                  </select>
                </label>
                <label>
                  <span x-html="lang.automation_rule_action"></span><br>
                  <small x-html="lang.automation_rule_action_desc"></small>
                  <template x-if="data.target !== 'picamera'">
                    <select x-model="data.action" required>
                      <option value="" disabled x-text="lang.select_placeholder"></option>
                      <option value="on" x-text="lang.automation_rule_action_on"></option>
                      <option value="off" x-text="lang.automation_rule_action_off"></option>
                    </select>
                  </template>
                  <template x-if="data.target === 'picamera'">
                    <select x-model="data.action" required>
                      <option value="" disabled x-text="lang.select_placeholder"></option>
                      <option value="on" x-text="lang.automation_rule_action_picture"></option>
                    </select>
                  </template>
                </label>
                <template x-if="(data.action === 'on')&&(data.target !== 'picamera')">
                  <label>
                    <span x-html="lang.automation_rule_duration"></span><br>
                    <small x-html="lang.automation_rule_duration_desc"></small>
                    <input x-model="data.duration" type="number" required>
                  </label>
                </template>
                <div>
                  <span x-html="lang.automation_rule_conditions"></span><br>
                  <small x-html="lang.automation_rule_conditions_desc" class="muted"></small>
                  (<small class="muted"><span x-text="lang.utc_time"></span> <code x-text="new Date().toISOString().substring(11, 16)"></code></small>).<br>
                  <template x-for="(condition, i) in data.conditions" :key="`${i}+${condition.data}+${condition.operator}`">
                    <div class="flex align-center">
                      <select x-model="condition.data" class="mr-.5">
                        <option value="" disabled x-text="lang.select_placeholder"></option>
                        <option value="time" x-text="lang.automation_rule_scheduled"></option>
                        <option value="temperature" x-text="lang.data_temperature"></option>
                        <option value="temperature_out" x-text="lang.data_temperature_out"></option>
                        <option value="humidity" x-text="lang.data_humidity"></option>
                        <option value="humidity_out" x-text="lang.data_humidity_out"></option>
                        <option value="co2" x-text="lang.data_co2"></option>
                        <option value="pressure" x-text="lang.data_pressure"></option>
                        <option value="noise" x-text="lang.data_noise"></option>
                        <option value="rain" x-text="lang.data_rain"></option>
                        <option value="windstrength" x-text="lang.data_windstrength"></option>
                        <option value="guststrength" x-text="lang.data_guststrength"></option>
                        <option value="windangle" x-text="lang.data_windangle"></option>
                        <option value="gustangle" x-text="lang.data_gustangle"></option>
                      </select>
                      <select x-model="condition.operator" class="mr-.5">
                        <option value="" disabled x-text="lang.select_placeholder"></option>
                        <option value="==" x-text="lang['automation_rule_operator_==']"></option>
                        <option value=">=" x-text="lang['automation_rule_operator_>=']"></option>
                        <option value="<=" x-text="lang['automation_rule_operator_<=']"></option>
                      </select>
                      <input x-model="condition.value" :type="condition.data === 'time' ? 'time' : 'number'" class="mr-.5">
                      <template x-if="(condition.data !== 'time')&&(condition.operator === '==')">
                        <span x-text="lang.automation_rule_delta"></span>
                      </template>
                      <template x-if="(condition.data !== 'time')&&(condition.operator === '==')">
                        <input x-model="condition.delta" type="number" step="0.1" class="mx-.5">
                      </template>
                      <button @click.prevent="data.conditions.splice(i, 1)" class="danger">-</button>
                    </div>
                  </template>
                  <button @click.prevent="data.conditions.push({data:'time', 'operator':'==', value:0, delta:0})" x-text="lang.automation_rule_button_add_condition"></button>
                </div>
                <label>
                  <span x-html="lang.automation_rule_ratelimit"></span><br>
                  <small x-html="lang.automation_rule_ratelimit_desc"></small>
                  <input x-model="data.ratelimit" type="number" required>
                </label>
                <footer>
                  <template x-if="method !== 'POST'">
                    <button type="reset" @click="await api($event, endpoint, {callback:() => { refresh_automation(); form_visible = false }, method:'DELETE'})" x-text="lang.automation_rule_button_delete"></button>
                  </template>
                  <button type="submit" @click="await api($event, endpoint, {callback:() => { refresh_automation(); if (method === 'POST') { form_visible = false ; data = {} } }, method, body:JSON.stringify(data)})" x-text="method === 'POST' ? lang.automation_rule_button_create : lang.automation_rule_button"></button>
                </footer>
              </form>
            </template>
          </div>
        </section>
      </template>

      <!-- Settings -->
      <template x-if="tab === 'settings'">
        <section>
          <!-- Meta -->
          <form x-data="{section:'settings_meta', endpoint:'/api/settings/meta', data:settings.meta}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, disabled, required, placeholder, type}) in [{name:'instance_name', required:true, placeholder:lang.app}, {name:'version', disabled:true}, {name:'mode', disabled:true}]" :key="name">
              <label>
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <footer>
              <button type="submit" @click="Object.assign(data, await api($event, endpoint, {method:'PUT', body:JSON.stringify(data)}))" x-text="lang[`${section}_button`]"></button>
            </footer>
          </form>
          <!-- Visibility -->
          <form x-data="{section:'settings_visibility', endpoint:'/api/settings/visibility', data:settings.visibility}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, disabled, required, placeholder, type}) in [{name:'public_pictures', type:'checkbox'}, {name:'public_camera', type:'checkbox'}, {name:'public_data', type:'checkbox'}, {name:'public_modules', type:'checkbox'}, {name:'public_history', type:'checkbox'}]" :key="name">
              <label>
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <template x-if="type === 'checkbox'">
                  <br>
                </template>
                <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <footer>
              <button type="submit" @click="Object.assign(data, await api($event, endpoint, {method:'PUT', body:JSON.stringify(data)}))" x-text="lang[`${section}_button`]"></button>
            </footer>
          </form>
          <!-- Tickrate -->
          <form x-data="{section:'settings_tickrate', endpoint:'/api/settings/tickrate', data:settings.tickrate}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, disabled, required, placeholder, type}) in [{name:'tickrate', type:'number'}, {name:'last_tick', type:'datetime-local', disabled:true}]" :key="name">
              <label>
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <footer>
              <button type="submit" @click="Object.assign(data, await api($event, endpoint, {method:'PUT', body:JSON.stringify(data)}))" x-text="lang[`${section}_button`]"></button>
            </footer>
          </form>
          <!-- Control server -->
          <form x-data="{section:'settings_control', endpoint:'/api/settings/control', data:settings.control}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, disabled, required, placeholder, type}) in [{name:'url', required:true, type:'url'}, {name:'token', required:true}]" :key="name">
              <label>
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <footer>
              <button class="active" @click="Object.assign(settings.control_test, await api($event, `${endpoint}/test`, {method:'GET'}))" x-text="lang[`${section}_button_test`]"></button>
              <button type="submit" @click="Object.assign(data, await api($event, endpoint, {method:'PUT', body:JSON.stringify(data)}))" x-text="lang[`${section}_button`]"></button>
            </footer>
          </form>
          <!-- Camera -->
          <form x-data="{section:'settings_camera', endpoint:'/api/settings/camera', data:settings.camera}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, disabled, required, placeholder, type}) in [{name:'url', required:true, type:'url'}, {name:'storage', required:true}]" :key="name">
              <label>
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <label>
              <span x-html="lang[`${section}_max_pictures`]"></span><br>
              <small x-html="lang[`${section}_max_pictures_desc`]"></small><br>
              <span x-text="pictures.length"></span> / <span x-text="data.max_pictures"></span>
              <progress :value="pictures.length" :max="data.max_pictures"></progress>
            </label>
            <footer>
              <button class="active" @click="Object.assign(settings.camera_test, await api($event, `${endpoint}/test`, {method:'GET'}))" x-text="lang[`${section}_button_test`]"></button>
              <button type="submit" @click="Object.assign(data, await api($event, endpoint, {method:'PUT', body:JSON.stringify(data)}))" x-text="lang[`${section}_button`]"></button>
            </footer>
          </form>
          <!-- Netatmo -->
          <form x-data="{section:'settings_netatmo', endpoint:'/api/settings/netatmo', data:settings.netatmo}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, disabled, required, placeholder, type}) in [{name:'client_id', required:true}, {name:'client_secret', required:true}, {name:'refresh_token', required:true}, {name:'access_token', disabled:true, placeholder:lang.netatmo_access_token_placeholder}, {name:'access_token_expiration', disabled:true, placeholder:lang.netatmo_access_token_placeholder, type:'datetime-local'}, {name:'user_mail', disabled:true, placeholder:lang.netatmo_access_token_placeholder}]" :key="name">
              <label>
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <footer>
              <button type="submit" @click="Object.assign(data, await api($event, endpoint, {method:'PUT', body:JSON.stringify(data)}))" x-text="lang[`${section}_button`]"></button>
            </footer>
            <!-- Netatmo modules -->
            <details class="mt-1" x-data="{section:'settings_netatmo_modules', modules:settings.netatmo_modules}">
              <summary x-html="lang[section]"></summary>
              <template x-if="!modules.length">
                <div class="flash muted" x-html="lang[`${section}_empty`]"></div>
              </template>
              <template x-for="module in modules" :key="module.mac">
                <article class="mt-1">
                  <header x-text="lang[`${section}_type_${module.type}_name`]"></header>
                  <template x-for="({name, type}) in [{name:'battery'}, {name:'mac'}, {name:'updated', type:'datetime-local'}]" :key="name">
                    <label>
                      <span x-html="lang[`${section}_${name}`]"></span><br>
                      <small x-html="lang[`${section}_${name}_desc`]"></small>
                      <template x-if="name === 'battery'">
                        <meter min="0" max="100" low="20" high="50" optimum="51" :value="module[name]"></meter>
                      </template>
                      <template x-if="name !== 'battery'">
                        <input x-model="module[name]" disabled :type="type ?? 'text'">
                      </template>
                    </label>
                  </template>
                </article>
              </template>
              <footer>
                <button @click="Object.assign(modules, await api($event, `${endpoint}/modules`, {method:'PUT'}))" x-text="lang[`${section}_button`]"></button>
              </footer>
            </details>
            <!-- Netatmo seeding -->
            <details class="mt-1" x-data="{t: new Date().toISOString().slice(0, 16)}">
              <summary x-html="lang.settings_netatmo_seed"></summary>
              <label>
                <span x-html="lang.settings_netatmo_seed_start"></span><br>
                <small x-html="lang.settings_netatmo_seed_start_desc"></small>
                <input x-model="t" type="datetime-local">
              </label>
              <footer>
                <button @click="await api($event, '/api/data', {method:'PUT', body:JSON.stringify({t})})" x-text="lang.settings_netatmo_seed_button"></button>
              </footer>
            </details>
          </form>
          <!-- Tapo -->
          <form x-data="{section:'settings_tapo', endpoint:'/api/settings/tapo', data:settings.tapo}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, disabled, required, placeholder, type}) in [{name:'username', required:true}, {name:'password', required:true}, {name:'api', required:true, type:'url'}, {name:'uuid', disabled:true, placeholder:lang.settings_tapo_token_placeholder}, {name:'token', disabled:true, placeholder:lang.settings_tapo_token_placeholder}]" :key="name">
              <label>
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <input x-model="data[name]" :disabled="disabled" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <footer>
              <button type="submit" @click="Object.assign(data, await api($event, endpoint, {method:'PUT', body:JSON.stringify(data)}))" x-text="lang[`${section}_button`]"></button>
            </footer>
            <!-- Tapo modules -->
            <details class="mt-1" x-data="{section:'settings_tapo_modules', modules:settings.tapo_modules}">
              <summary x-html="lang[section]"></summary>
              <template x-if="!modules.length">
                <div class="flash muted" x-html="lang[`${section}_empty`]"></div>
              </template>
              <template x-for="module in modules" :key="module.mac">
                <article class="mt-1">
                  <header x-text="module.name"></header>
                  <template x-for="({name, type}) in [{name:'mac'}, {name:'model'}, {name:'firmware'}]" :key="name">
                    <label>
                      <span x-html="lang[`${section}_${name}`]"></span><br>
                      <small x-html="lang[`${section}_${name}_desc`]"></small>
                      <input x-model="module[name]" disabled :type="type ?? 'text'">
                    </label>
                  </template>
                </article>
              </template>
              <footer>
                <button @click="Object.assign(modules, await api($event, `${endpoint}/modules`, {method:'PUT'}))" x-text="lang[`${section}_button`]"></button>
              </footer>
            </details>
          </form>
          <!-- Notes -->
          <form x-data="{section:'settings_notes', endpoint:'/api/settings/notes', data:settings.notes}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <label>
              <textarea style="resize: both;" rows="12" x-model="data.content"></textarea>
            </label>
            <footer>
              <button type="submit" @click="Object.assign(data, await api($event, endpoint, {method:'PUT', body:JSON.stringify(data)}))" x-text="lang[`${section}_button`]"></button>
            </footer>
          </form>
          <!-- Other -->
          <form x-data="{section:'settings_others'}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <form class="bd-muted">
              <small class="muted" x-html="lang[`${section}_force_tick_desc`]"></small><br>
              <button @click="await api($event, '/api/tick', {method:'POST'})" x-text="lang[`${section}_force_tick`]"></button>
            </form>
            <form class="bd-muted">
              <small class="muted" x-html="lang[`${section}_delete_data_desc`]"></small><br>
              <button class="attention" @click="await api($event, '/api/data', {method:'DELETE'})" x-text="lang[`${section}_delete_data`]"></button>
            </form>
            <form class="bd-muted">
              <small class="muted" x-html="lang[`${section}_export_desc`]"></small><br>
              <button @click.prevent="window.open('/api/export', '_blank')" x-text="lang[`${section}_export`]"></button>
            </form>
            <form class="bd-muted">
              <label>
                <span x-html="lang[`${section}_import`]"></span><br>
                <small x-html="lang[`${section}_import_desc`]"></small>
                <input id="config-import" type="file">
              </label>
              <button class="attention" @click="await api($event, '/api/import', {callback:() => location.reload(), method:'POST', body:document.querySelector('#config-import')?.files[0]})" x-text="lang[`${section}_import`]"></button>
            </form>
            <form class="bd-muted">
              <small class="muted" x-html="lang[`${section}_exit_desc`]"></small><br>
              <button class="danger" @click="await api($event, '/api/exit', {callback:() => { status = 'exited'; tab = '' }, method:'POST'})" x-text="lang[`${section}_exit`]"></button>
            </form>
          </form>
        </section>
      </template>

      <!-- Setup -->
      <template x-if="tab === 'setup'">
        <section>
          <form x-data="{section:'setup', endpoint:'/setup', data:setup}">
            <h2 x-html="lang[section]"></h2>
            <div class="muted mb-1" x-html="lang[`${section}_desc`]"></div>
            <template x-for="({name, required, placeholder, type}) in [{name:'instance_name', required:true, placeholder:lang.app}, {name:'admin_username', required:true}, {name:'admin_password', required:true, type:'password'}]" :key="name">
              <label>
                <span x-html="lang[`${section}_${name}`]"></span><br>
                <small x-html="lang[`${section}_${name}_desc`]"></small>
                <input x-model="data[name]" :required="required" :placeholder="placeholder" :type="type ?? 'text'">
              </label>
            </template>
            <footer>
              <button type="submit" @click="await api($event, endpoint, {callback:() => location.reload(), method:'POST', body:JSON.stringify(data)})" x-text="lang.setup_button"></button>
            </footer>
          </form>
        </section>
      </template>

      <!-- Exited -->
      <template x-if="status === 'exited'">
        <section>
          <div class="flash danger" x-html="lang.settings_others_exited"></div>
        </section>
      </template>

    </main>

    <!-- Footer -->
    <footer>
      <nav>
        <menu>
          <li><a href="https://github.com/lowlighter/gardenia" target="_blank">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" width="16" height="16"><path d="M8 0c4.42 0 8 3.58 8 8a8.013 8.013 0 0 1-5.45 7.59c-.4.08-.55-.17-.55-.38 0-.27.01-1.13.01-2.2 0-.75-.25-1.23-.54-1.48 1.78-.2 3.65-.88 3.65-3.95 0-.88-.31-1.59-.82-2.15.08-.2.36-1.02-.08-2.12 0 0-.67-.22-2.2.82-.64-.18-1.32-.27-2-.27-.68 0-1.36.09-2 .27-1.53-1.03-2.2-.82-2.2-.82-.44 1.1-.16 1.92-.08 2.12-.51.56-.82 1.28-.82 2.15 0 3.06 1.86 3.75 3.64 3.95-.23.2-.44.55-.51 1.07-.46.21-1.61.55-2.33-.66-.15-.24-.6-.83-1.23-.82-.67.01-.27.38.01.53.34.19.73.9.82 1.13.16.45.68 1.31 2.69.94 0 .67.01 1.3.01 1.49 0 .21-.15.45-.55.38A7.995 7.995 0 0 1 0 8c0-4.42 3.58-8 8-8Z"></path></svg>
          </a></li>
          <li class="muted" x-text="`${lang.app} ${settings.meta.version}`"></li>
        </menu>
      </nav>
    </footer>
    <script src="/app.js"></script>
  </body>
</html>